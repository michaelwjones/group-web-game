<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Test Harness</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 0.75rem;
            gap: 0.75rem;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        h1 {
            font-size: 1.25rem;
            color: #8b5cf6;
        }

        .config-panel {
            background: #2a2a4a;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        .config-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        label {
            font-size: 0.75rem;
            color: #aaa;
            text-transform: uppercase;
        }

        input[type="number"], select {
            background: #1a1a2e;
            border: 1px solid #444;
            border-radius: 0.25rem;
            padding: 0.5rem;
            color: #eee;
            font-size: 0.875rem;
        }

        input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            accent-color: #8b5cf6;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0;
        }

        .checkbox-group label {
            text-transform: none;
            font-size: 0.875rem;
            color: #eee;
        }

        button {
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            cursor: pointer;
        }

        button:hover { background: #7c3aed; }
        button:disabled { background: #444; cursor: not-allowed; }
        button.secondary { background: #444; }
        button.secondary:hover { background: #555; }
        button.danger { background: #dc2626; }
        button.danger:hover { background: #b91c1c; }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.875rem;
        }

        .status-bar .code {
            font-family: monospace;
            background: #333;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            color: #8b5cf6;
        }

        .status-bar .status { color: #aaa; }
        .status-bar .status.ready { color: #22c55e; }

        /* --- Frame grid --- */
        .frame-area {
            flex: 1;
            display: grid;
            gap: 0.5rem;
            min-height: 0;
            /* JS sets grid-template-columns based on available width */
        }

        .frame-wrapper {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 2px solid #333;
            background: #111;
            min-height: 0;
        }

        .frame-wrapper.display {
            border-color: #8b5cf6;
        }

        .frame-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(51, 51, 51, 0.85);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            z-index: 10;
            pointer-events: none;
        }

        .frame-wrapper.display .frame-label {
            background: rgba(139, 92, 246, 0.85);
        }

        .frame-wrapper iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Game Test Harness</h1>
            <div class="status-bar" id="statusBar" style="display: none;">
                <span>Game: <span class="code" id="currentCode">-</span></span>
                <span class="status" id="status">Starting...</span>
                <button class="danger" onclick="reset()">Reset</button>
                <button class="secondary" onclick="toggleFullscreen()">Fullscreen</button>
            </div>
        </div>

        <div id="setupPanel">
            <div class="config-panel">
                <div class="config-group">
                    <label for="gameType">Game</label>
                    <select id="gameType">
                        <option value="trivia">Trivia</option>
                        <option value="blind-artists" selected>Blind Artists</option>
                    </select>
                </div>
                <div class="config-group">
                    <label for="playerCount">Players</label>
                    <input type="number" id="playerCount" value="12" min="1" max="20" style="width: 4rem;">
                </div>
                <div class="config-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="includeDisplay" checked>
                        <label for="includeDisplay">Include Display</label>
                    </div>
                </div>
                <button onclick="startTest()" id="startBtn">Start Test</button>
            </div>
        </div>

        <div class="frame-area" id="frameArea" style="display: none;"></div>
    </div>

    <script>
        const BASE_URL = 'https://michaelwjones.github.io/group-web-game';

        const MIN_FRAME_WIDTH = 260;

        let gameCode = null;
        let isRunning = false;
        let joinedCount = 0;
        let expectedTotal = 0;
        let gameCodeTimeout = null;
        let totalFrames = 0;

        function log(msg) { console.log('[harness]', msg); }

        function updateStatus(text, ready = false) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = 'status' + (ready ? ' ready' : '');
        }

        function layoutGrid() {
            const frameArea = document.getElementById('frameArea');
            if (!frameArea || !isRunning) return;

            const gap = 8; // 0.5rem
            const availableWidth = frameArea.clientWidth;
            const cols = Math.max(1, Math.min(totalFrames, Math.floor((availableWidth + gap) / (MIN_FRAME_WIDTH + gap))));
            const rows = Math.ceil(totalFrames / cols);

            frameArea.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            frameArea.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
        }

        function addFrame(id, label, url, cssClass) {
            const frameArea = document.getElementById('frameArea');
            const wrapper = document.createElement('div');
            wrapper.className = 'frame-wrapper ' + cssClass;
            wrapper.id = 'frame-' + id;

            const lbl = document.createElement('div');
            lbl.className = 'frame-label';
            lbl.textContent = label;

            const iframe = document.createElement('iframe');
            iframe.src = url;
            iframe.title = label;

            wrapper.appendChild(lbl);
            wrapper.appendChild(iframe);
            frameArea.appendChild(wrapper);
            log('Frame added: ' + label);

            layoutGrid();
        }

        function handleMessage(event) {
            if (!event.data || typeof event.data.type !== 'string') return;
            const data = event.data;
            log('Message: ' + JSON.stringify(data));

            switch (data.type) {
                case 'GAME_CREATED':
                    if (data.code && !gameCode) {
                        gameCode = data.code;
                        document.getElementById('currentCode').textContent = gameCode;
                        if (gameCodeTimeout) { clearTimeout(gameCodeTimeout); gameCodeTimeout = null; }
                        log('Game created: ' + gameCode);
                        updateStatus('Spawning players...');
                        setTimeout(spawnPlayers, 1500);
                    }
                    break;

                case 'JOINED':
                    joinedCount++;
                    log('Joined: ' + data.clientId + ' (' + joinedCount + '/' + expectedTotal + ')');
                    if (joinedCount >= expectedTotal) {
                        updateStatus('Ready! Host can start the game.', true);
                    } else {
                        updateStatus('Joining... (' + joinedCount + '/' + expectedTotal + ')');
                    }
                    break;

                case 'ERROR':
                    log('Error from iframe: ' + data.message);
                    break;
            }
        }

        function startTest() {
            if (isRunning) return;

            const gameType = document.getElementById('gameType').value;
            const playerCount = parseInt(document.getElementById('playerCount').value) || 2;
            const includeDisplay = document.getElementById('includeDisplay').checked;

            isRunning = true;
            gameCode = null;
            joinedCount = 0;
            expectedTotal = playerCount + (includeDisplay ? 1 : 0);
            totalFrames = expectedTotal;

            // Show frame area, hide config
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('statusBar').style.display = 'flex';
            const frameArea = document.getElementById('frameArea');
            frameArea.innerHTML = '';
            frameArea.style.display = 'grid';

            layoutGrid();

            updateStatus('Creating game (may take ~30s if server is cold)...');
            window.addEventListener('message', handleMessage);

            gameCodeTimeout = setTimeout(() => {
                if (!gameCode) log('Still waiting for game code... server may be waking up');
            }, 10000);

            // Create the first frame
            if (includeDisplay) {
                addFrame('display', 'Display',
                    `${BASE_URL}/?autoCreate=true&gameType=${gameType}&asDisplay=true&testMode=true&testClientId=display`,
                    'display');
            } else {
                addFrame('p1', 'Player 1',
                    `${BASE_URL}/?autoCreate=true&gameType=${gameType}&playerName=${encodeURIComponent('Player 1')}&testMode=true&testClientId=p1`,
                    'player');
            }
        }

        function spawnPlayers() {
            if (!gameCode) { log('No game code yet'); return; }

            const includeDisplay = document.getElementById('includeDisplay').checked;
            const startIndex = includeDisplay ? 1 : 2;
            const playerCount = parseInt(document.getElementById('playerCount').value) || 2;

            for (let i = startIndex; i <= playerCount; i++) {
                const delay = (i - startIndex) * 500;
                setTimeout(() => {
                    addFrame('p' + i, 'Player ' + i,
                        `${BASE_URL}/play/${gameCode}?autoJoin=true&playerName=${encodeURIComponent('Player ' + i)}&testMode=true&testClientId=p${i}`,
                        'player');
                }, delay);
            }
        }

        function reset() {
            window.removeEventListener('message', handleMessage);
            if (gameCodeTimeout) { clearTimeout(gameCodeTimeout); gameCodeTimeout = null; }
            isRunning = false;
            gameCode = null;
            joinedCount = 0;
            totalFrames = 0;

            document.getElementById('setupPanel').style.display = 'block';
            document.getElementById('statusBar').style.display = 'none';
            document.getElementById('frameArea').style.display = 'none';
            document.getElementById('frameArea').innerHTML = '';
        }

        function toggleFullscreen() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        }

        window.addEventListener('resize', layoutGrid);
    </script>
</body>
</html>
